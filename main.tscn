[gd_scene load_steps=14 format=3 uid="uid://de68u7hdnog6c"]

[ext_resource type="Script" uid="uid://cm5gry3adi78i" path="res://Main.cs" id="1_h2yge"]
[ext_resource type="PackedScene" uid="uid://cbr6s2bd62f0j" path="res://Player.tscn" id="2_0xm2m"]
[ext_resource type="Script" uid="uid://b6avd2binwqkk" path="res://FpsLabel.cs" id="4_1bvp3"]
[ext_resource type="PackedScene" uid="uid://h7lgc0lx8o5c" path="res://main_ambient.tscn" id="5_lquwl"]

[sub_resource type="Shader" id="Shader_1bvp3"]
code = "shader_type spatial;

// The base color of the object. 'source_color' provides a color picker in the editor.
uniform vec4 albedo : source_color;

// The number of discrete steps/bands for the light. 
// A higher number gives a smoother transition.
uniform int steps = 2;

// The strength of the specular highlight.
uniform float specular_strength = 0.5;

// The smoothness of the specular highlight.
uniform float specular_smoothness = 16.0;

// Custom uniform for the light direction, set from a script.
uniform vec3 light_direction;

void fragment() {
    // Standard lighting calculation using the dot product of the normal and light direction.
    // This value, NdotL, ranges from -1 (fully shaded) to 1 (fully lit).
    float NdotL = dot(NORMAL, light_direction);

    // FIX: Clamp NdotL to a positive range (0.0 to 1.0) to prevent negative values from causing blackness.
    NdotL = max(0.0, NdotL);

    // --- Core Toon Shading Logic ---
    // We quantize the NdotL value to create discrete bands of light and shadow.
    // This is the \"cel-shading\" effect.
    float light_band = floor(NdotL * float(steps)) / float(steps);

    // Clamp the value to ensure it stays within the 0.0 to 1.0 range.
    light_band = clamp(light_band, 0.0, 1.0);

    // Apply the stepped lighting to the albedo color.
    vec3 toon_color = albedo.rgb * light_band;

    // --- Specular Highlight Logic ---
    // We calculate a simple specular highlight using the same light direction.
    vec3 view_dir = normalize(VIEW);
    vec3 half_vector = normalize(light_direction + view_dir);

    // The dot product of the normal and the half vector gives the highlight intensity.
    float specular_intensity = dot(NORMAL, half_vector);

    // Clamp and power the intensity to create a sharp, focused highlight.
    specular_intensity = pow(clamp(specular_intensity, 0.0, 1.0), specular_smoothness);

    // We also step the specular highlight to match the toon shading style.
    float specular_band = floor(specular_intensity * float(steps)) / float(steps);
    specular_band = clamp(specular_band, 0.0, 1.0);

    // Combine the stepped color with the stepped specular highlight.
    vec3 final_color = toon_color + (vec3(1.0) * specular_band * specular_strength);
    
    // Set the final albedo and roughness.
    //ALBEDO = final_color;
	ALBEDO = toon_color;
    ROUGHNESS = 1.0;
	
	ALBEDO = albedo.rgb;
}
"

[sub_resource type="QuadMesh" id="QuadMesh_1bvp3"]

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_lquwl"]
albedo_color = Color(0.197667, 1, 0.17, 1)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_7mycd"]
albedo_color = Color(1, 0.24, 0.24, 1)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_272bh"]
albedo_color = Color(0.16, 0.16, 1, 1)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_5vw27"]
albedo_color = Color(0.08, 1, 0.923333, 1)

[sub_resource type="Animation" id="Animation_lquwl"]
length = 40.0
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("SubViewportContainer/SubViewport/cutS:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 4, 20, 24, 28, 40),
"transitions": PackedFloat32Array(1.68179, 0.574349, 1.8025, 1.93187, 0.517632, 2.07053),
"update": 0,
"values": [Vector3(3.21562, 1.49822, 1.12217), Vector3(0.316867, 2.17845, 0.50348), Vector3(-9.53019, 4.48916, -1.5982), Vector3(-9.53019, 4.48916, -1.5982), Vector3(-5.62657, 3.57313, -0.765042), Vector3(3.21562, 1.49822, 1.12217)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("SubViewportContainer/SubViewport/cutS:rotation")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 0.966667, 20.0333, 24, 38.2333, 40),
"transitions": PackedFloat32Array(1.41421, 0.707107, 1, 1.51572, 0.482968, 0.482968),
"update": 0,
"values": [Vector3(0, 0.872665, 0), Vector3(0, 0.896814, 0), Vector3(0, 1.54387, 0), Vector3(0, 1.54387, 0), Vector3(0, 0.920326, 0), Vector3(0, 0.872665, 0)]
}

[sub_resource type="Animation" id="Animation_1bvp3"]
resource_name = "cutscene"
length = 5.0
loop_mode = 1
tracks/0/type = "position_3d"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("SubViewportContainer/SubViewport/cutS")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = PackedFloat32Array()
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("SubViewportContainer/SubViewport/cutS:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 2.5, 5),
"transitions": PackedFloat32Array(1, 1, 1),
"update": 0,
"values": [Vector3(3.21562, 1.49822, 1.12217), Vector3(-9.15524, 3.67805, -1.48011), Vector3(3.21562, 1.49822, 1.12217)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_7mycd"]
_data = {
&"RESET": SubResource("Animation_lquwl"),
&"cutscene": SubResource("Animation_1bvp3")
}

[node name="Main" type="Node" node_paths=PackedStringArray("DirectionalLight", "TargetMesh")]
script = ExtResource("1_h2yge")
DirectionalLight = NodePath("DirectionalLight3D")
TargetMesh = NodePath("SubViewportContainer/SubViewport/CharacterBody3D/Camera_Controller/Camera3D/MeshInstance3D")
toonShader = SubResource("Shader_1bvp3")

[node name="SubViewportContainer" type="SubViewportContainer" parent="."]
texture_filter = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
stretch = true
stretch_shrink = 4

[node name="SubViewport" type="SubViewport" parent="SubViewportContainer"]
handle_input_locally = false
size = Vector2i(320, 180)
render_target_update_mode = 4

[node name="CharacterBody3D" parent="SubViewportContainer/SubViewport" instance=ExtResource("2_0xm2m")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.90841, 7.98753, 0)

[node name="FpsLabel" type="Label" parent="SubViewportContainer/SubViewport"]
offset_right = 1.0
offset_bottom = 23.0
size_flags_horizontal = 0
size_flags_vertical = 0
theme_override_font_sizes/font_size = 10
script = ExtResource("4_1bvp3")

[node name="cutS" type="Camera3D" parent="SubViewportContainer/SubViewport"]
transform = Transform3D(0.642787, 0, 0.766045, 0, 1, 0, -0.766045, 0, 0.642787, 3.21562, 1.49822, 1.12217)

[node name="StaticBody3D" type="StaticBody3D" parent="SubViewportContainer/SubViewport"]

[node name="MeshInstance3D" type="MeshInstance3D" parent="SubViewportContainer/SubViewport/StaticBody3D"]
transform = Transform3D(9.32883, 0, 0, 0, -4.23643e-07, 1, 0, -9.69183, -4.37114e-08, -2.2, 1, 14.1793)
mesh = SubResource("QuadMesh_1bvp3")
surface_material_override/0 = SubResource("StandardMaterial3D_lquwl")

[node name="MeshInstance3D2" type="MeshInstance3D" parent="SubViewportContainer/SubViewport/StaticBody3D"]
transform = Transform3D(9.32883, 0, 0, 0, -4.23643e-07, 1, 0, -9.69183, -4.37114e-08, -8.96644, 0.352304, 19.9703)
mesh = SubResource("QuadMesh_1bvp3")
surface_material_override/0 = SubResource("StandardMaterial3D_7mycd")

[node name="MeshInstance3D3" type="MeshInstance3D" parent="SubViewportContainer/SubViewport/StaticBody3D"]
transform = Transform3D(9.32883, 0, 0, 0, -4.23643e-07, 1, 0, -9.69183, -4.37114e-08, -0.569666, -0.0730286, 23.1652)
mesh = SubResource("QuadMesh_1bvp3")
surface_material_override/0 = SubResource("StandardMaterial3D_272bh")

[node name="MeshInstance3D4" type="MeshInstance3D" parent="SubViewportContainer/SubViewport/StaticBody3D"]
transform = Transform3D(9.32883, 0, 0, 0, -4.23643e-07, 1, 0, -9.69183, -4.37114e-08, 2.74544, 1.84455, 16.5968)
mesh = SubResource("QuadMesh_1bvp3")
surface_material_override/0 = SubResource("StandardMaterial3D_5vw27")

[node name="main_ambient" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]

[node name="main_ambient6" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]
transform = Transform3D(-8.74228e-08, 0, -2, 0, 2, 0, 2, 0, -8.74228e-08, -24.15, 0, 54.05)

[node name="main_ambient2" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]
transform = Transform3D(-8.74228e-08, 0, -2, 0, 2, 0, 2, 0, -8.74228e-08, -24.2438, 3.83059, -21.4005)

[node name="main_ambient3" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]
transform = Transform3D(2, 0, 0, 0, 2, 0, 0, 0, 2, -45.6438, 3.83059, -0.000506222)

[node name="main_ambient4" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]
transform = Transform3D(2, 0, 0, 0, 2, 0, 0, 0, 2, -45.6438, 3.83059, -29.9505)

[node name="main_ambient5" parent="SubViewportContainer/SubViewport" instance=ExtResource("5_lquwl")]
transform = Transform3D(2, 0, 0, 0, 2, 0, 0, 0, 2, -45.6438, 3.83059, 29.8495)

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(0.879474, -0.330787, -0.342207, 0.468659, 0.727218, 0.501511, 0.0829657, -0.601444, 0.794596, 6.5699, 5.63357, 13.5617)
light_energy = 1.211
shadow_enabled = true
shadow_blur = 0.52
directional_shadow_max_distance = 42.5

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_7mycd")
}
autoplay = "RESET"

[node name="OmniLight3D" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -6.5, 1.10424, -3.9)
light_energy = 1.407
shadow_enabled = true

[node name="OmniLight3D2" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.25429, 1.31228, 3.64625)
light_energy = 1.407
shadow_enabled = true

[node name="OmniLight3D3" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.841344, 0.60877, -3.75916)
light_energy = 1.407
shadow_enabled = true

[node name="OmniLight3D4" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2.45428, 0.320347, 3.36172)
light_energy = 1.407
shadow_enabled = true

[node name="OmniLight3D5" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -13.8859, 7.46834, 4.86672)
light_energy = 1.407
shadow_enabled = true

[node name="OmniLight3D6" type="OmniLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 0.997021, 0.0771367, 0, -0.0771367, 0.997021, -14.9627, 3.52877, -1.95701)
light_energy = 1.407
shadow_enabled = true
